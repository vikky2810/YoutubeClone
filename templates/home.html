{% extends 'base.html' %}

{% block description %}A privacy-focused, lightweight YouTube frontend. Search and watch videos without tracking.{%
endblock %}
{% block title %}ViewTube - Home{% endblock %}

{% block main_content %}
<!-- Category Chips -->
<div class="yt-chips-bar" id="chips-bar">
    <button class="yt-chips-scroll-left" id="chips-scroll-left" aria-label="Scroll left" style="display:none;">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
        </svg>
    </button>
    <div class="yt-chips-wrapper" id="chips-wrapper">
        <button class="yt-chip active" data-filter="all">All</button>
        <button class="yt-chip" data-filter="music">Music</button>
        <button class="yt-chip" data-filter="gaming">Gaming</button>
        <button class="yt-chip" data-filter="news">News</button>
        <button class="yt-chip" data-filter="movies">Movies</button>
        <button class="yt-chip" data-filter="sports">Sports</button>
        <button class="yt-chip" data-filter="tech">Technology</button>
        <button class="yt-chip" data-filter="cooking">Cooking</button>
        <button class="yt-chip" data-filter="education">Education</button>
        <button class="yt-chip" data-filter="travel">Travel</button>
        <button class="yt-chip" data-filter="fitness">Fitness</button>
        <button class="yt-chip" data-filter="comedy">Comedy</button>
        <button class="yt-chip" data-filter="science">Science</button>
        <button class="yt-chip" data-filter="fashion">Fashion</button>
    </div>
    <button class="yt-chips-scroll-right" id="chips-scroll-right" aria-label="Scroll right">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
        </svg>
    </button>
</div>

<!-- Video Grid Content -->
<div id="home-content">
    <div class="yt-video-grid" id="home-video-grid">
        <!-- Videos injected by JS -->
    </div>

    <!-- Initial Loading State -->
    <div id="loading-spinner" class="yt-loading-container">
        <div class="yt-spinner"></div>
        <p>Loading trending videos...</p>
    </div>

    <!-- Error State -->
    <div id="error-message" class="yt-no-results" style="display: none;">
        <svg viewBox="0 0 24 24" width="64" height="64" fill="#aaa">
            <path
                d="M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z" />
        </svg>
        <h2 id="error-title">Something went wrong</h2>
        <p id="error-text">Check your internet connection or try searching for a video.</p>
        <button onclick="location.reload()" class="yt-btn-secondary"
            style="margin-top: 16px; padding: 8px 16px; border-radius: 18px; border: 1px solid #555; background: transparent; color: white; cursor: pointer;">Retry</button>
    </div>

    <!-- Infinite Scroll Sentinel + bottom spinner -->
    <div id="scroll-sentinel" style="height: 1px;"></div>
    <div id="bottom-spinner" class="yt-loading-container" style="display: none; padding: 32px 0;">
        <div class="yt-spinner"></div>
        <p>Loading more videos...</p>
    </div>
    <div id="end-of-feed" style="display: none; text-align: center; padding: 24px; color: #aaa; font-size: 14px;">
        — You're all caught up —
    </div>
</div>

<style>
    .yt-chips-scroll-right,
    .yt-chips-scroll-left {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--yt-bg-chip, #272727);
        border: none;
        color: var(--yt-text-primary, #f1f1f1);
        cursor: pointer;
        transition: background 0.2s;
    }

    .yt-chips-scroll-right {
        box-shadow: -8px 0 12px 6px var(--yt-bg-main, #0f0f0f);
    }

    .yt-chips-scroll-left {
        box-shadow: 8px 0 12px 6px var(--yt-bg-main, #0f0f0f);
    }

    .yt-chips-scroll-right:hover,
    .yt-chips-scroll-left:hover {
        background: #3f3f3f;
    }

    .yt-loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 100px 0;
        color: #aaa;
    }

    .yt-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const grid = document.getElementById('home-video-grid');
        const loader = document.getElementById('loading-spinner');
        const errorBox = document.getElementById('error-message');
        const sentinel = document.getElementById('scroll-sentinel');
        const botSpinner = document.getElementById('bottom-spinner');
        const endOfFeed = document.getElementById('end-of-feed');

        const PAGE_SIZE = 12;
        let currentOffset = 0;
        let isLoading = false;
        let hasMore = true;
        let activeFilter = 'all'; // 'all' uses trending, anything else uses search

        // ─── Video card renderer ───────────────────────────────────────
        function makeCard(video) {
            const article = document.createElement('article');
            article.className = 'yt-video-card';
            article.tabIndex = 0;
            article.innerHTML = `
                <a href="/watch?v=${video.id}" class="yt-video-card-link" aria-label="${video.title}">
                    <div class="yt-thumbnail-wrapper">
                        <img src="${video.thumbnail}" alt="${video.title}" class="yt-thumbnail" loading="lazy">
                        ${video.duration ? `<span class="yt-duration">${video.duration}</span>` : ''}
                    </div>
                    <div class="yt-video-card-info">
                        <div class="yt-channel-icon-small">
                            <span>${video.channel ? video.channel[0].toUpperCase() : 'V'}</span>
                        </div>
                        <div class="yt-video-card-text">
                            <h3 class="yt-video-card-title" title="${video.title}">${video.title}</h3>
                            <p class="yt-video-card-channel">${video.channel}</p>
                            <p class="yt-video-card-meta">${video.view_count}</p>
                        </div>
                    </div>
                </a>
            `;
            return article;
        }

        function appendVideos(videos) {
            videos.forEach(v => grid.appendChild(makeCard(v)));
        }

        // ─── Fetch a page of videos ────────────────────────────────────
        async function fetchPage(offset) {
            if (isLoading || !hasMore) return;
            isLoading = true;

            const isFirstLoad = offset === 0;
            if (isFirstLoad) {
                loader.style.display = 'flex';
                errorBox.style.display = 'none';
            } else {
                botSpinner.style.display = 'flex';
            }

            try {
                let url;
                if (activeFilter === 'all') {
                    url = `/api/trending?offset=${offset}`;
                } else {
                    url = `/api/search-more?q=${encodeURIComponent(activeFilter)}&offset=${offset}`;
                }

                const resp = await fetch(url);
                const raw = await resp.json();

                // /api/trending returns [] array; /api/search-more returns { videos: [] }
                const videos = Array.isArray(raw) ? raw : (raw.videos || []);

                loader.style.display = 'none';

                if (isFirstLoad && videos.length === 0) {
                    errorBox.style.display = 'flex';
                    document.getElementById('error-title').textContent = 'No videos found';
                    document.getElementById('error-text').textContent = 'Try searching for a specific topic.';
                    hasMore = false;
                    return;
                }

                if (videos.length < PAGE_SIZE) {
                    // Received a partial page — this is the last one
                    hasMore = false;
                }

                if (videos.length === 0) {
                    endOfFeed.style.display = 'block';
                    return;
                }

                appendVideos(videos);
                currentOffset += videos.length;

                if (!hasMore) endOfFeed.style.display = 'block';

            } catch (err) {
                console.error('Fetch error:', err);
                if (offset === 0) {
                    loader.style.display = 'none';
                    errorBox.style.display = 'flex';
                    document.getElementById('error-title').textContent = '⚠️ Connection Failed';
                    document.getElementById('error-text').textContent =
                        'Could not contact the server. Make sure Flask is running on port 5000.';
                }
            } finally {
                isLoading = false;
                botSpinner.style.display = 'none';
            }
        }

        // ─── Reset & load fresh (on chip change) ───────────────────────
        function resetAndLoad(filter) {
            activeFilter = filter;
            currentOffset = 0;
            hasMore = true;
            grid.innerHTML = '';
            endOfFeed.style.display = 'none';
            errorBox.style.display = 'none';
            loader.style.display = 'flex';
            fetchPage(0);
        }

        // ─── IntersectionObserver for infinite scroll ──────────────────
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting && hasMore && !isLoading) {
                    fetchPage(currentOffset);
                }
            });
        }, { rootMargin: '400px' });   // trigger 400px before sentinel enters view

        observer.observe(sentinel);

        // ─── Chip filter interaction ───────────────────────────────────
        const chips = document.querySelectorAll('.yt-chip');
        chips.forEach(chip => {
            chip.addEventListener('click', () => {
                chips.forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                const filter = chip.getAttribute('data-filter');
                resetAndLoad(filter === 'all' ? 'all' : filter);
            });
        });

        // ─── Chips scroll buttons ──────────────────────────────────────
        const scrollRight = document.getElementById('chips-scroll-right');
        const scrollLeft = document.getElementById('chips-scroll-left');
        const chipsWrapper = document.getElementById('chips-wrapper');

        function updateScrollBtns() {
            if (!chipsWrapper) return;
            const { scrollLeft: sl, scrollWidth, clientWidth } = chipsWrapper;
            scrollLeft && (scrollLeft.style.display = sl > 0 ? 'flex' : 'none');
            scrollRight && (scrollRight.style.display = sl + clientWidth < scrollWidth - 1 ? 'flex' : 'none');
        }

        if (scrollRight && chipsWrapper) {
            scrollRight.addEventListener('click', () => {
                chipsWrapper.scrollBy({ left: 200, behavior: 'smooth' });
            });
        }
        if (scrollLeft && chipsWrapper) {
            scrollLeft.addEventListener('click', () => {
                chipsWrapper.scrollBy({ left: -200, behavior: 'smooth' });
            });
        }
        if (chipsWrapper) {
            chipsWrapper.addEventListener('scroll', updateScrollBtns);
            updateScrollBtns(); // run once on load
        }

        // ─── Initial load ──────────────────────────────────────────────
        fetchPage(0);
    });
</script>
{% endblock %}