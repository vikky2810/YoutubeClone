{% extends 'base.html' %}

{% block description %}A privacy-focused, lightweight YouTube frontend. Search and watch videos without tracking.{%
endblock %}
{% block title %}ViewTube - Home{% endblock %}

{% block main_content %}
<!-- Category Chips -->
<div class="yt-chips-bar" id="chips-bar">
    <div class="yt-chips-wrapper">
        <button class="yt-chip active" data-filter="all">All</button>
        <button class="yt-chip" data-filter="music">Music</button>
        <button class="yt-chip" data-filter="gaming">Gaming</button>
        <button class="yt-chip" data-filter="news">News</button>
        <button class="yt-chip" data-filter="movies">Movies</button>
        <button class="yt-chip" data-filter="sports">Sports</button>
        <button class="yt-chip" data-filter="tech">Technology</button>
        <button class="yt-chip" data-filter="cooking">Cooking</button>
        <button class="yt-chip" data-filter="education">Education</button>
        <button class="yt-chip" data-filter="travel">Travel</button>
        <button class="yt-chip" data-filter="fitness">Fitness</button>
        <button class="yt-chip" data-filter="comedy">Comedy</button>
        <button class="yt-chip" data-filter="science">Science</button>
        <button class="yt-chip" data-filter="fashion">Fashion</button>
    </div>
    <button class="yt-chips-scroll-right" aria-label="Scroll right">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
        </svg>
    </button>
</div>

<!-- Video Grid Content -->
<div id="home-content">
    <div class="yt-video-grid" id="home-video-grid">
        <!-- Videos will be injected here by JS -->
    </div>

    <!-- Loading State -->
    <div id="loading-spinner" class="yt-loading-container">
        <div class="yt-spinner"></div>
        <p>Loading trending videos...</p>
    </div>

    <!-- Error State -->
    <div id="error-message" class="yt-no-results" style="display: none;">
        <svg viewBox="0 0 24 24" width="64" height="64" fill="#aaa">
            <path
                d="M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z" />
        </svg>
        <h2 id="error-title">Something went wrong</h2>
        <p id="error-text">Check your internet connection or try searching for a video.</p>
        <button onclick="location.reload()" class="yt-btn-secondary"
            style="margin-top: 16px; padding: 8px 16px; border-radius: 18px; border: 1px solid #555; background: transparent; color: white; cursor: pointer;">Retry</button>
    </div>
</div>

<style>
    .yt-loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 100px 0;
        color: #aaa;
    }

    .yt-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const grid = document.getElementById('home-video-grid');
        const loader = document.getElementById('loading-spinner');
        const error = document.getElementById('error-message');

        function fetchTrending() {
            fetch('/api/trending')
                .then(response => {
                    // Always parse JSON, even on error status
                    return response.json().then(data => ({ status: response.status, data }));
                })
                .then(({ status, data }) => {
                    loader.style.display = 'none';

                    // Handle typed errors from backend
                    if (data.error) {
                        error.style.display = 'flex';
                        if (data.error === 'network_error') {
                            document.getElementById('error-title').textContent = 'ðŸŒ No Internet Connection';
                            document.getElementById('error-text').textContent =
                                'The server cannot reach YouTube. Make sure your internet connection is active, then restart the Flask server.';
                        } else if (data.error === 'no_results') {
                            document.getElementById('error-title').textContent = 'No Trending Videos';
                            document.getElementById('error-text').textContent =
                                'YouTube returned no results right now. Try searching for something specific.';
                        } else {
                            document.getElementById('error-title').textContent = 'Something Went Wrong';
                            document.getElementById('error-text').textContent = data.message || 'An unexpected error occurred.';
                        }
                        return;
                    }

                    // Success
                    if (!data || data.length === 0) {
                        error.style.display = 'flex';
                        document.getElementById('error-title').textContent = "No videos found";
                        document.getElementById('error-text').textContent = "Try searching for a specific topic.";
                        return;
                    }
                    renderVideos(data);
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    loader.style.display = 'none';
                    error.style.display = 'flex';
                    document.getElementById('error-title').textContent = 'âš ï¸ Connection Failed';
                    document.getElementById('error-text').textContent =
                        'Could not contact the server. Make sure Flask is running on port 5000.';
                });
        }

        function renderVideos(videos) {
            grid.innerHTML = videos.map(video => `
                <article class="yt-video-card" tabindex="0">
                    <a href="/watch?v=${video.id}" class="yt-video-card-link" aria-label="${video.title}">
                        <div class="yt-thumbnail-wrapper">
                            <img src="${video.thumbnail}" alt="${video.title}" class="yt-thumbnail" loading="lazy">
                            ${video.duration ? `<span class="yt-duration">${video.duration}</span>` : ''}
                        </div>
                        <div class="yt-video-card-info">
                            <div class="yt-channel-icon-small">
                                <span>${video.channel ? video.channel[0].toUpperCase() : 'V'}</span>
                            </div>
                            <div class="yt-video-card-text">
                                <h3 class="yt-video-card-title" title="${video.title}">${video.title}</h3>
                                <p class="yt-video-card-channel">${video.channel}</p>
                                <p class="yt-video-card-meta">${video.view_count}</p>
                            </div>
                        </div>
                    </a>
                </article>
            `).join('');
        }

        // Action!
        fetchTrending();

        // Chip filter interaction
        const chips = document.querySelectorAll('.yt-chip');
        chips.forEach(chip => {
            chip.addEventListener('click', () => {
                chips.forEach(c => c.classList.remove('active'));
                chip.classList.add('active');

                // Optional: Re-fetch based on filter
                const filter = chip.getAttribute('data-filter');
                if (filter !== 'all') {
                    grid.innerHTML = '';
                    loader.style.display = 'flex';
                    error.style.display = 'none';
                    // Simulation of search for simplicity
                    fetch(`/api/search-more?q=${filter}&offset=0`)
                        .then(r => r.json())
                        .then(data => {
                            loader.style.display = 'none';
                            renderVideos(data.videos);
                        });
                } else {
                    grid.innerHTML = '';
                    loader.style.display = 'flex';
                    fetchTrending();
                }
            });
        });

        // Chips scroll
        const scrollBtn = document.querySelector('.yt-chips-scroll-right');
        const chipsWrapper = document.querySelector('.yt-chips-wrapper');
        if (scrollBtn && chipsWrapper) {
            scrollBtn.addEventListener('click', () => {
                chipsWrapper.scrollBy({ left: 200, behavior: 'smooth' });
            });
        }
    });
</script>
{% endblock %}